{{ define "title" }}Search{{ end }}

{{ define "header" }}
<!-- Header with background image - article page style -->
<header class="cover bg-top header-wrapper" style="background-image: url('/images/2023/05/h_IMG_2435.jpeg'); background-position: center;">
    <div class="bg-black-30 bb bt">
        <!-- Compact nav - same as article pages -->
        <div class="glass-nav hide-print">
            <nav class="sans-serif border-box pa3 ph5-l">
                <a href="{{ .Site.BaseURL }}" title="Home">
                    <img
                        src="{{ "img/logo.jpg" | absURL }}"
                        class="w2 h2 br-100"
                        alt="{{ .Site.Title }}"
                    />
                </a>
                <div class="fr h2 pv2 tr">
                    {{- range .Site.Menus.main }}
                    <a class="link f5 ml2 dim near-white" href="{{ .URL }}">{{ .Name }}</a>
                    {{- end }}
                    {{- range .Site.Menus.social }}
                    <a class="icon-link-small" href="{{ .URL }}"><i class="{{ .Title }}"></i></a>
                    {{- end }}
                    <a class="icon-link-small" href="{{ "index.xml" | absURL }}" title="RSS Feed"><i class="fas fa-rss"></i></a>
                    <a class="icon-link-small search-icon-active" href="{{ "search/" | absURL }}" title="Search"><i class="fas fa-search"></i></a>
                </div>
            </nav>
        </div>

        <!-- Title area - matching article page style -->
        <div class="tc-l pv3-ns pv4-l pv2 ph3 ph4-ns">
            <h1 class="near-white mt1-ns f2 fw3 mb0 mt0 lh-title">
                <span class="terminal-title">Search rmoff.netâ€¦<span class="terminal-cursor"></span></span>
            </h1>
        </div>
    </div>
</header>
{{ end }}

{{ define "main" }}

<!-- Vertically centered search area -->
<div class="search-center-area">
    <div class="search-box-wrapper">
        <div id="search"></div>
    </div>
</div>

<!-- Popular categories at bottom -->
<div class="search-footer-area">
    <div id="search-suggestions" class="search-suggestions">
        <p class="suggestions-label">Popular categories:</p>
        <div class="suggestion-chips">
            {{- $topCats := slice }}
            {{- range $i, $term := .Site.Taxonomies.categories }}
                {{- if lt $i 12 }}
                    {{- $topCats = $topCats | append (dict "name" $term.Page.Title "url" $term.Page.Permalink "count" (len $term.Pages)) }}
                {{- end }}
            {{- end }}
            {{- range sort $topCats "count" "desc" | first 8 }}
            <a href="{{ .url }}" class="suggestion-chip">{{ .name }}</a>
            {{- end }}
        </div>
    </div>
</div>

<link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/pagefind/pagefind-ui.js"></script>
<script>
    // Categories data generated by Hugo at build time
    const categories = {{ $cats := slice }}{{ range $term := .Site.Taxonomies.categories }}{{ $cats = $cats | append (dict "name" $term.Page.Title "url" $term.Page.Permalink "count" (len $term.Pages)) }}{{ end }}{{ $cats | jsonify | safeJS }};

    window.addEventListener('DOMContentLoaded', (event) => {
        const searchContainer = document.getElementById('search');

        const pf = new PagefindUI({
            element: "#search",
            showImages: true,
            showSubResults: false,
            excerptLength: 10
        });

        // Create and inject category results div after the form
        const categoryResults = document.createElement('div');
        categoryResults.id = 'category-results';

        // Watch for the form to appear and inject category div after it
        const injectCategory = setInterval(() => {
            const form = searchContainer.querySelector('.pagefind-ui__form');
            const resultsWrapper = searchContainer.querySelector('.pagefind-ui__results-area');
            if (form && resultsWrapper) {
                clearInterval(injectCategory);
                // Insert category results between form and results
                resultsWrapper.parentNode.insertBefore(categoryResults, resultsWrapper);
                // Continuously remove the default search icon (we use terminal prompt instead)
                const removeIcon = () => {
                    const icons = searchContainer.querySelectorAll('.pagefind-ui__search-icon, .pagefind-ui svg');
                    icons.forEach(el => {
                        el.style.display = 'none';
                        el.style.visibility = 'hidden';
                    });
                };
                removeIcon();
                setInterval(removeIcon, 100); // Keep checking
            }
        }, 50);

        // URL state management
        function getQueryFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('q') || '';
        }

        function updateURL(query) {
            const url = new URL(window.location);
            if (query) {
                url.searchParams.set('q', query);
            } else {
                url.searchParams.delete('q');
            }
            window.history.replaceState({}, '', url);
        }

        // Watch for input changes to filter categories and update URL
        const suggestions = document.getElementById('search-suggestions');
        const checkForInput = setInterval(() => {
            const searchInput = document.querySelector('.pagefind-ui__search-input');
            if (searchInput) {
                clearInterval(checkForInput);

                // Load initial query from URL
                const initialQuery = getQueryFromURL();
                if (initialQuery) {
                    searchInput.value = initialQuery;
                    // Trigger Pagefind search
                    searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                    suggestions.classList.add('hidden');
                    updateCategoryResults(initialQuery.toLowerCase());
                }

                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase().trim();
                    updateCategoryResults(query);
                    updateURL(e.target.value.trim());
                    // Hide suggestions when typing
                    if (query.length > 0) {
                        suggestions.classList.add('hidden');
                    } else {
                        suggestions.classList.remove('hidden');
                    }
                });
            }
        }, 100);

        function updateCategoryResults(query) {
            if (!query || query.length < 2) {
                categoryResults.innerHTML = '';
                return;
            }

            // Find matching categories
            const matches = categories.filter(cat =>
                cat.name.toLowerCase().includes(query)
            ).slice(0, 8); // Limit to 8 matches

            if (matches.length === 0) {
                categoryResults.innerHTML = '';
                return;
            }

            // Render category matches
            categoryResults.innerHTML = `
                <div class="category-matches">
                    <h3 class="category-matches-heading">Matching categories</h3>
                    <div class="category-chips">
                        ${matches.map(cat => `
                            <a href="${cat.url}" class="category-chip">
                                ${cat.name}
                                <span class="category-count">${cat.count}</span>
                            </a>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Infinite scroll: auto-click "Load more" when it comes into view
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.click();
                }
            });
        }, { rootMargin: '200px', threshold: 0 });

        // Check if element is in viewport
        function isInViewport(el) {
            const rect = el.getBoundingClientRect();
            return rect.top < window.innerHeight + 200 && rect.bottom > -200;
        }

        // Watch for the "Load more" button to appear
        const mutationObserver = new MutationObserver(() => {
            const loadMoreBtn = searchContainer.querySelector('.pagefind-ui__button');
            if (loadMoreBtn && !loadMoreBtn.dataset.observed) {
                loadMoreBtn.dataset.observed = 'true';
                observer.observe(loadMoreBtn);
                // Immediately check if already in view and click
                if (isInViewport(loadMoreBtn)) {
                    loadMoreBtn.click();
                }
            }
        });
        mutationObserver.observe(searchContainer, { childList: true, subtree: true });
    });
</script>

<style>
/* Push footer to bottom of viewport */
body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

main {
    flex: 1;
    display: flex;
    flex-direction: column;
}

/* Highlight active search icon in header */
.search-icon-active {
    background: rgba(255, 255, 255, 0.2) !important;
    border-radius: 4px;
    padding: 0.25rem 0.5rem !important;
}

/* Centered search area - focal point */
.search-center-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
    min-height: 50vh;
}

.search-box-wrapper {
    width: 100%;
    max-width: 600px;
}

/* Popular categories - just above footer */
.search-footer-area {
    padding: 2rem 1rem;
    display: flex;
    justify-content: center;
    background: #f8f8f8;
    border-top: 1px solid #eee;
    margin-top: auto;
}

.search-footer-area .search-suggestions {
    max-width: 600px;
    width: 100%;
    background: transparent;
    border: none;
    box-shadow: none;
    padding: 0;
}

.search-footer-area .suggestions-label {
    text-align: center;
}

.search-footer-area .suggestion-chips {
    justify-content: center;
}

/* Pagefind styling */
.pagefind-ui {
    --pagefind-ui-scale: 0.9;
    --pagefind-ui-primary: #1a1a1a;
    --pagefind-ui-text: #333;
    --pagefind-ui-background: #fff;
    --pagefind-ui-border: #e5e5e5;
    --pagefind-ui-tag: #f5f5f5;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 8px;
    --pagefind-ui-font: 'Quattrocento Sans', sans-serif;
    --pagefind-ui-image-border-radius: 8px;
    --pagefind-ui-image-box-ratio: 3 / 2;
}

/* Light search input - matching card aesthetic */
.pagefind-ui__form {
    position: relative !important;
}

.pagefind-ui__search-input {
    font-family: 'Quattrocento Sans', sans-serif !important;
    font-size: 1.1rem !important;
    padding: 1rem 1rem 1rem 3rem !important;
    background: #ffffff !important;
    color: #333 !important;
    border: 1px solid #e5e5e5 !important;
    border-radius: 12px !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    transition: border-color 0.2s ease, box-shadow 0.2s ease !important;
}

.pagefind-ui__search-input::placeholder {
    color: #999 !important;
    font-family: 'Quattrocento Sans', sans-serif !important;
}

.pagefind-ui__search-input:focus {
    border-color: #ccc !important;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15) !important;
    outline: none !important;
}

/* Hide default search icon, use terminal prompt instead */
.pagefind-ui__search-icon {
    opacity: 0 !important;
    pointer-events: none !important;
}

.pagefind-ui .pagefind-ui__search-icon svg,
.pagefind-ui__form svg {
    opacity: 0 !important;
}

/* Terminal prompt */
.pagefind-ui__form::before {
    content: ">";
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    color: #333;
    font-family: 'Source Code Pro', 'Monaco', monospace;
    font-weight: bold;
    font-size: 1.4rem;
    z-index: 9999;
    pointer-events: none;
}


/* Clear button styling */
.pagefind-ui__search-clear {
    color: #666 !important;
    opacity: 0.6 !important;
    transition: opacity 0.15s ease !important;
}

.pagefind-ui__search-clear:hover {
    opacity: 1 !important;
}

/* Category matches section */
.category-matches {
    margin-top: 1rem;
    margin-bottom: 0;
    padding-bottom: 0.75rem;
}

/* Tighten spacing in results area */
.pagefind-ui__drawer {
    gap: 0 !important;
    margin-top: 0 !important;
    padding-top: 0 !important;
}

.pagefind-ui__results-area {
    margin-top: 0 !important;
    padding-top: 0 !important;
}

/* Category results - full width above article results */
#category-results {
    display: block !important;
    width: 100% !important;
    margin-bottom: 1rem;
}

.category-matches {
    display: block !important;
    width: 100% !important;
}

.category-matches-heading {
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #666;
    margin: 0 0 0.75rem 0;
    font-weight: 600;
    font-family: 'Quattrocento Sans', sans-serif;
}

.category-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.category-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.75rem;
    background: #f8f8f8;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    color: #444;
    text-decoration: none;
    font-size: 0.8rem;
    font-family: 'Quattrocento Sans', sans-serif;
    transition: all 0.15s ease;
}

.category-chip:hover {
    background: #333;
    color: #fff;
    border-color: #333;
    text-decoration: none;
}

.category-count {
    font-size: 0.7rem;
    color: #999;
    font-weight: 500;
}

.category-chip:hover .category-count {
    color: rgba(255, 255, 255, 0.7);
}

/* Results count */
.pagefind-ui__message {
    margin-top: 0.5rem !important;
    margin-bottom: 1rem !important;
    font-size: 0.85rem !important;
    color: #666 !important;
    font-family: 'Quattrocento Sans', sans-serif !important;
}

/* Result cards matching homepage aesthetic */
.pagefind-ui__results {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.pagefind-ui__result {
    display: flex !important;
    align-items: flex-start !important;
    gap: 1.25rem !important;
    padding: 1.25rem !important;
    margin: 0 !important;
    background: #ffffff !important;
    border: 1px solid #e5e5e5 !important;
    border-radius: 12px !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    transition: all 0.15s ease !important;
    position: relative !important;
    overflow: hidden !important;
}

/* Terminal accent bar on hover */
.pagefind-ui__result:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15) !important;
    border-color: #d0d0d0 !important;
}

/* Larger thumbnails like homepage */
.pagefind-ui__result-thumb {
    width: 120px !important;
    min-width: 120px !important;
    height: 80px !important;
    margin: 0 !important;
    flex-shrink: 0 !important;
    border-radius: 8px !important;
    overflow: hidden !important;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1) !important;
    align-self: center !important;
}

@media (min-width: 768px) {
    .pagefind-ui__result-thumb {
        width: 160px !important;
        min-width: 160px !important;
        height: 107px !important;
    }
}

.pagefind-ui__result-thumb img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
}

/* Inner content takes remaining space */
.pagefind-ui__result-inner {
    flex: 1 !important;
    min-width: 0 !important;
}

.pagefind-ui__result-link {
    color: #333 !important;
    text-decoration: none !important;
    font-size: 1.1rem !important;
    font-weight: 600 !important;
    line-height: 1.3 !important;
    font-family: 'Quattrocento Sans', sans-serif !important;
    display: block !important;
    margin-bottom: 0.5rem !important;
}

.pagefind-ui__result-link:hover {
    color: #000 !important;
    text-decoration: none !important;
}

.pagefind-ui__result-excerpt {
    font-size: 0.875rem !important;
    line-height: 1.6 !important;
    color: #555 !important;
    margin-top: 0 !important;
    font-family: 'Quattrocento Sans', sans-serif !important;
    display: -webkit-box !important;
    -webkit-line-clamp: 2 !important;
    -webkit-box-orient: vertical !important;
    overflow: hidden !important;
}

/* Highlighted search matches */
.pagefind-ui__result-excerpt mark {
    background: #fff3cd !important;
    color: inherit !important;
    padding: 0.1em 0.2em !important;
    border-radius: 2px !important;
}

/* Hide sub-results */
.pagefind-ui__result-nested {
    display: none !important;
}

/* Load more button */
.pagefind-ui__button {
    background: #fff !important;
    border: 1px solid #e0e0e0 !important;
    color: #555 !important;
    font-size: 0.85rem !important;
    padding: 0.75rem 1.5rem !important;
    border-radius: 6px !important;
    font-family: 'Source Code Pro', monospace !important;
    cursor: pointer !important;
    transition: all 0.15s ease !important;
    margin-top: 1rem !important;
}

.pagefind-ui__button:hover {
    background: #f5f5f5 !important;
    border-color: #ccc !important;
}

/* Empty state - Terminal panel with scanlines */
/* Empty state - card style matching homepage */
.search-suggestions {
    margin-top: 1.5rem;
    padding: 1.5rem;
    background: #ffffff;
    border: 1px solid #e5e5e5;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.search-suggestions.hidden {
    display: none;
}

.suggestions-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: #666;
    margin: 0 0 1rem 0;
    font-weight: 600;
    font-family: 'Quattrocento Sans', sans-serif;
}

.suggestion-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.suggestion-chip {
    display: inline-block;
    padding: 0.5rem 1rem;
    background: #f8f8f8;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    color: #444;
    text-decoration: none;
    font-size: 0.85rem;
    font-family: 'Quattrocento Sans', sans-serif;
    transition: all 0.15s ease;
}

.suggestion-chip:hover {
    background: #333;
    color: #fff;
    border-color: #333;
    text-decoration: none;
}

</style>

{{ end }}
