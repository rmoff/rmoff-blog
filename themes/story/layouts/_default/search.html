{{ define "title" }}Search{{ end }}
{{ define "main" }}

<article class="center ph3 nested-copy-line-height lh-copy f4 nested-links mw-100 measure-wide pt3">
   {{ .Content }}
   <div id="search"></div>
   <div id="search-suggestions" class="search-suggestions">
       <p class="suggestions-label">Popular categories:</p>
       <div class="suggestion-chips">
           {{- $topCats := slice }}
           {{- range $i, $term := .Site.Taxonomies.categories }}
               {{- if lt $i 12 }}
                   {{- $topCats = $topCats | append (dict "name" $term.Page.Title "url" $term.Page.Permalink "count" (len $term.Pages)) }}
               {{- end }}
           {{- end }}
           {{- range sort $topCats "count" "desc" | first 8 }}
           <a href="{{ .url }}" class="suggestion-chip">{{ .name }}</a>
           {{- end }}
       </div>
   </div>
</article>

<link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/pagefind/pagefind-ui.js"></script>
<script>
    // Categories data generated by Hugo at build time
    const categories = {{ $cats := slice }}{{ range $term := .Site.Taxonomies.categories }}{{ $cats = $cats | append (dict "name" $term.Page.Title "url" $term.Page.Permalink "count" (len $term.Pages)) }}{{ end }}{{ $cats | jsonify | safeJS }};

    window.addEventListener('DOMContentLoaded', (event) => {
        const searchContainer = document.getElementById('search');

        const pf = new PagefindUI({
            element: "#search",
            showImages: true,
            showSubResults: false,
            excerptLength: 10
        });

        // Create and inject category results div after the form
        const categoryResults = document.createElement('div');
        categoryResults.id = 'category-results';

        // Watch for the form to appear and inject category div after it
        const injectCategory = setInterval(() => {
            const form = searchContainer.querySelector('.pagefind-ui__form');
            const resultsWrapper = searchContainer.querySelector('.pagefind-ui__results-area');
            if (form && resultsWrapper) {
                clearInterval(injectCategory);
                // Insert category results between form and results
                resultsWrapper.parentNode.insertBefore(categoryResults, resultsWrapper);
            }
        }, 50);

        // Watch for input changes to filter categories
        const suggestions = document.getElementById('search-suggestions');
        const checkForInput = setInterval(() => {
            const searchInput = document.querySelector('.pagefind-ui__search-input');
            if (searchInput) {
                clearInterval(checkForInput);

                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase().trim();
                    updateCategoryResults(query);
                    // Hide suggestions when typing
                    if (query.length > 0) {
                        suggestions.classList.add('hidden');
                    } else {
                        suggestions.classList.remove('hidden');
                    }
                });
            }
        }, 100);

        function updateCategoryResults(query) {
            if (!query || query.length < 2) {
                categoryResults.innerHTML = '';
                return;
            }

            // Find matching categories
            const matches = categories.filter(cat =>
                cat.name.toLowerCase().includes(query)
            ).slice(0, 8); // Limit to 8 matches

            if (matches.length === 0) {
                categoryResults.innerHTML = '';
                return;
            }

            // Render category matches
            categoryResults.innerHTML = `
                <div class="category-matches">
                    <h3 class="category-matches-heading">Categories</h3>
                    <div class="category-chips">
                        ${matches.map(cat => `
                            <a href="${cat.url}" class="category-chip">
                                ${cat.name}
                                <span class="category-count">${cat.count}</span>
                            </a>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Infinite scroll: auto-click "Load more" when it comes into view
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.click();
                }
            });
        }, { rootMargin: '200px' });

        // Watch for the "Load more" button to appear
        const mutationObserver = new MutationObserver(() => {
            const loadMoreBtn = searchContainer.querySelector('.pagefind-ui__button');
            if (loadMoreBtn && !loadMoreBtn.dataset.observed) {
                loadMoreBtn.dataset.observed = 'true';
                observer.observe(loadMoreBtn);
            }
        });
        mutationObserver.observe(searchContainer, { childList: true, subtree: true });
    });
</script>

<style>
/* Pagefind styling to match site theme */
.pagefind-ui {
    --pagefind-ui-scale: 0.9;
    --pagefind-ui-primary: #333;
    --pagefind-ui-text: #333;
    --pagefind-ui-background: #fff;
    --pagefind-ui-border: #eeeeee;
    --pagefind-ui-tag: #f0f0f0;
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 8px;
    --pagefind-ui-font: 'Domine', Georgia, Times, serif;
    --pagefind-ui-image-border-radius: 4px;
    --pagefind-ui-image-box-ratio: 3 / 2;
}

.pagefind-ui__search-input {
    font-size: 1.25rem !important;
    padding: 0.75rem 1rem 0.75rem 3rem !important;
}

/* Category matches section */
.category-matches {
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #eee;
}

.category-matches-heading {
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #666;
    margin: 0 0 0.75rem 0;
    font-weight: 600;
}

.category-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.category-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.75rem;
    background: #f5f5f5;
    border: 1px solid #ddd;
    border-radius: 20px;
    color: #333;
    text-decoration: none;
    font-size: 0.9rem;
    transition: all 0.15s ease;
}

.category-chip:hover {
    background: #333;
    color: #fff;
    border-color: #333;
}

.category-count {
    font-size: 0.75rem;
    color: #888;
    background: #e0e0e0;
    padding: 0.1rem 0.4rem;
    border-radius: 10px;
}

.category-chip:hover .category-count {
    background: rgba(255,255,255,0.2);
    color: #fff;
}

/* Compact result layout */
.pagefind-ui__result {
    padding: 0.75rem 0 !important;
    border-bottom: 1px solid #eee;
}

.pagefind-ui__result-inner {
    display: flex !important;
    align-items: flex-start !important;
    gap: 1rem !important;
}

.pagefind-ui__result-thumb {
    width: 80px !important;
    min-width: 80px !important;
    height: 53px !important;
    margin: 0 !important;
    flex-shrink: 0 !important;
}

.pagefind-ui__result-thumb img {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
    border-radius: 4px !important;
}

.pagefind-ui__result-link {
    color: #333 !important;
    text-decoration: none !important;
    font-size: 1rem !important;
    font-weight: 600 !important;
    line-height: 1.3 !important;
}

.pagefind-ui__result-link:hover {
    text-decoration: underline !important;
}

.pagefind-ui__result-excerpt {
    font-size: 0.85rem !important;
    line-height: 1.4 !important;
    color: #666 !important;
    margin-top: 0.25rem !important;
    display: -webkit-box !important;
    -webkit-line-clamp: 2 !important;
    -webkit-box-orient: vertical !important;
    overflow: hidden !important;
}

/* Hide sub-results completely */
.pagefind-ui__result-nested {
    display: none !important;
}

/* Search suggestions for empty state */
.search-suggestions {
    margin-top: 2rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px;
    border: 1px solid #dee2e6;
}

.search-suggestions.hidden {
    display: none;
}

.suggestions-label {
    font-size: 0.9rem;
    color: #666;
    margin: 0 0 1rem 0;
    font-weight: 500;
}

.suggestion-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.suggestion-chip {
    display: inline-block;
    padding: 0.4rem 0.9rem;
    background: white;
    border: 1px solid #ddd;
    border-radius: 20px;
    color: #333;
    text-decoration: none;
    font-size: 0.85rem;
    transition: all 0.15s ease;
}

.suggestion-chip:hover {
    background: #333;
    color: #fff;
    border-color: #333;
    text-decoration: none;
}

</style>

{{ end }}
