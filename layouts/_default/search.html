{{ define "title" }}Search &bullet; {{ .Site.Title }}{{ end }}

{{ define "main" }}
<div class="page-hero" style="background-image: url('/images/2023/05/h_IMG_2435.jpeg');">
    <div class="page-hero-overlay">
        <div class="page-hero-content">
            <h1>Search</h1>
        </div>
    </div>
</div>
<div class="container" style="padding-top: 2rem; padding-bottom: 3rem;">

    <div class="search-wrapper">
        <div id="search"></div>
    </div>

    <!-- Popular categories -->
    <div id="search-suggestions" class="search-suggestions-redesign">
        <p class="search-suggestions-label">Popular categories:</p>
        <div class="search-suggestion-chips">
            {{- $topCats := slice }}
            {{- range $i, $term := .Site.Taxonomies.categories }}
                {{- if lt $i 13 }}
                    {{- $topCats = $topCats | append (dict "name" $term.Page.Title "url" $term.Page.Permalink "count" (len $term.Pages)) }}
                {{- end }}
            {{- end }}
            {{- range sort $topCats "count" "desc" | first 8 }}
            <a href="{{ .url }}" class="search-suggestion-chip">{{ .name }}</a>
            {{- end }}
        </div>
    </div>
</div>

<link href="/pagefind/pagefind-ui.css" rel="stylesheet">
<script src="/pagefind/pagefind-ui.js"></script>
<script>
    // Categories data generated by Hugo at build time
    const categories = {{ $cats := slice }}{{ range $term := .Site.Taxonomies.categories }}{{ $cats = $cats | append (dict "name" $term.Page.Title "url" $term.Page.Permalink "count" (len $term.Pages)) }}{{ end }}{{ $cats | jsonify | safeJS }};

    window.addEventListener('DOMContentLoaded', (event) => {
        const searchContainer = document.getElementById('search');

        const pf = new PagefindUI({
            element: "#search",
            showImages: true,
            showSubResults: false,
            excerptLength: 10
        });

        // Create and inject category results div after the form
        const categoryResults = document.createElement('div');
        categoryResults.id = 'category-results';

        const injectCategory = setInterval(() => {
            const form = searchContainer.querySelector('.pagefind-ui__form');
            const resultsWrapper = searchContainer.querySelector('.pagefind-ui__results-area');
            if (form && resultsWrapper) {
                clearInterval(injectCategory);
                resultsWrapper.parentNode.insertBefore(categoryResults, resultsWrapper);
            }
        }, 50);

        // URL state management
        function getQueryFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('q') || '';
        }

        function updateURL(query) {
            const url = new URL(window.location);
            if (query) {
                url.searchParams.set('q', query);
            } else {
                url.searchParams.delete('q');
            }
            window.history.replaceState({}, '', url);
        }

        const suggestions = document.getElementById('search-suggestions');
        const checkForInput = setInterval(() => {
            const searchInput = document.querySelector('.pagefind-ui__search-input');
            if (searchInput) {
                clearInterval(checkForInput);

                // Auto-focus the search input
                searchInput.focus();

                const initialQuery = getQueryFromURL();
                if (initialQuery) {
                    searchInput.value = initialQuery;
                    searchInput.dispatchEvent(new Event('input', { bubbles: true }));
                    suggestions.classList.add('hidden');
                    updateCategoryResults(initialQuery.toLowerCase());
                }

                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase().trim();
                    updateCategoryResults(query);
                    updateURL(e.target.value.trim());
                    if (query.length > 0) {
                        suggestions.classList.add('hidden');
                    } else {
                        suggestions.classList.remove('hidden');
                    }
                });
            }
        }, 100);

        function updateCategoryResults(query) {
            if (!query || query.length < 2) {
                categoryResults.innerHTML = '';
                return;
            }

            const matches = categories.filter(cat =>
                cat.name.toLowerCase().includes(query)
            ).slice(0, 8);

            if (matches.length === 0) {
                categoryResults.innerHTML = '';
                return;
            }

            categoryResults.innerHTML = `
                <div class="search-cat-matches">
                    <h3 class="search-cat-heading">Matching categories</h3>
                    <div class="search-cat-chips">
                        ${matches.map(cat => `
                            <a href="${cat.url}" class="search-suggestion-chip">
                                ${cat.name}
                                <span class="cat-count">${cat.count}</span>
                            </a>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Infinite scroll: auto-click "Load more"
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) entry.target.click();
            });
        }, { rootMargin: '200px', threshold: 0 });

        const mutationObserver = new MutationObserver(() => {
            const loadMoreBtn = searchContainer.querySelector('.pagefind-ui__button');
            if (loadMoreBtn && !loadMoreBtn.dataset.observed) {
                loadMoreBtn.dataset.observed = 'true';
                observer.observe(loadMoreBtn);
            }
        });
        mutationObserver.observe(searchContainer, { childList: true, subtree: true });
    });
</script>

<style>
.search-wrapper {
    max-width: 700px;
    margin-bottom: 2rem;
}

.search-suggestions-redesign {
    max-width: 700px;
    padding: 1.25rem;
    background: #fff;
    border: 1px solid var(--color-border);
}

.search-suggestions-redesign.hidden {
    display: none;
}

.search-suggestions-label {
    font-family: var(--font-ui);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--color-text-muted);
    margin: 0 0 0.75rem 0;
    font-weight: 600;
}

.search-suggestion-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
}

.search-suggestion-chip {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.4rem 0.75rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    color: var(--color-text);
    text-decoration: none;
    font-family: var(--font-ui);
    font-size: 0.8rem;
    transition: all 0.15s ease;
}

.search-suggestion-chip:hover {
    background: var(--color-text);
    color: var(--color-bg);
    border-color: var(--color-text);
}

.search-cat-matches {
    margin: 1rem 0;
}

.search-cat-heading {
    font-family: var(--font-ui);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--color-text-muted);
    margin: 0 0 0.5rem 0;
    font-weight: 600;
}

.search-cat-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
}

/* Pagefind overrides for redesign */
.pagefind-ui {
    --pagefind-ui-scale: 0.9;
    --pagefind-ui-primary: var(--color-text);
    --pagefind-ui-text: var(--color-text);
    --pagefind-ui-background: #fff;
    --pagefind-ui-border: var(--color-border);
    --pagefind-ui-tag: var(--color-bg);
    --pagefind-ui-border-width: 1px;
    --pagefind-ui-border-radius: 0px;
    --pagefind-ui-font: var(--font-ui);
    --pagefind-ui-image-border-radius: 0px;
    --pagefind-ui-image-box-ratio: 3 / 2;
}

.pagefind-ui__search-input {
    font-family: var(--font-ui) !important;
    font-size: 1rem !important;
    border-radius: 0 !important;
}

.pagefind-ui__result {
    border-radius: 0 !important;
    border: 1px solid var(--color-border) !important;
    padding: 1rem !important;
}

.pagefind-ui__result-link {
    font-family: var(--font-body) !important;
    color: var(--color-link) !important;
}

.pagefind-ui__result-excerpt {
    font-family: var(--font-body) !important;
    font-size: 0.85rem !important;
}

.pagefind-ui__result-excerpt mark {
    background: #FFF3CD !important;
}

.pagefind-ui__button {
    border-radius: 0 !important;
    font-family: var(--font-ui) !important;
}
</style>
{{ end }}
