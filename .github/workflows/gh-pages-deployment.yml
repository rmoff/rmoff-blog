name: Build & deploy live site

on:
  push:
    branches:
     - main
#   schedule:
#     # Run on the hour
#     - cron: '0 * * * *'

jobs:
  build-deploy:
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      packages: read
    steps:
    - uses: actions/checkout@v3

    - name: Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build reveal.js presentations (requires local asciidoctor)
      run: |
        sudo apt-get update
        sudo apt-get install -y ruby-dev
        sudo gem install asciidoctor asciidoctor-revealjs
        ./build-slides.sh

    - name: Build Hugo site with Docker
      run: |
        docker run --rm \
          -v $(pwd):/src \
          ghcr.io/${{ github.repository }}:0.152.2 \
          --destination public

    - name: Build Pagefind search index
      run: npx pagefind --site public

    - name: Deploy
      uses: peaceiris/actions-gh-pages@v3
      with:
        deploy_key: ${{ secrets.ACTIONS_DEPLOY_KEY }}
        external_repository: rmoff/rmoff.github.io
        publish_branch: master
        # Without `keep_files` the `CNAME` file in the target repo will get removed
        # and the custom domain configured for GitHub pages will get dropped every
        # time the action runsâ€¦
        keep_files: true
